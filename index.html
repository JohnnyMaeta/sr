<!doctype html><meta charset="utf-8">
<title>提出アプリ</title>
<style>body{font-family:system-ui;padding:16px;max-width:760px;margin:auto}button{padding:8px 12px}</style>

<h2>提出アプリ</h2>
<p>通常の音声・動画・静止画の提出は従来どおり。<br>
画面録画で提出する場合は下のボタンを押してください。</p>

<button id="openRecorder">画面録画モードを開く（新しいタブ）</button>
<p style="color:#666">※ ポップアップをブロックしている場合、許可してください。</p>

<script>
const GAS_ENDPOINT = 'YOUR_EXEC_URL_HERE'; // 例: https://script.google.com/macros/s/XXXXX/exec
const TOKEN = 'mikireiemoto';

document.getElementById('openRecorder').addEventListener('click', () => {
  const w = window.open('', '_blank');
  if (!w) { alert('ポップアップがブロックされています。許可してください。'); return; }

  // ここで録画用の完全HTMLをその場で書き込む
  const html = `<!doctype html><meta charset="utf-8">
  <title>Screen Recorder</title>
  <style>
    body{font-family:system-ui;padding:16px;max-width:760px;margin:auto}
    button{padding:8px 12px;margin-right:8px}
    video{width:100%;max-width:740px;background:#000;margin-top:8px}
    #status{margin-top:8px;min-height:1.2em}
  </style>
  <h2>画面録画 → Drive保存</h2>
  <div>
    <button id="start">録画開始</button>
    <button id="stop" disabled>停止</button>
    <button id="upload" disabled>Driveに保存</button>
  </div>
  <div style="margin-top:8px">
    <label>ファイル名 <input id="fname" value="screen-record.webm"></label>
    <label>音声 <input type="checkbox" id="withAudio" checked></label>
    <label>ビットレート
      <select id="bitrate">
        <option value="2500000">2.5 Mbps</option>
        <option value="1500000" selected>1.5 Mbps</option>
        <option value="800000">0.8 Mbps</option>
      </select>
    </label>
  </div>
  <video id="v" controls playsinline></video>
  <div id="status"></div>

  <script>
  (() => {
    const ENDPOINT = ${JSON.stringify(GAS_ENDPOINT)};
    const TOKEN = ${JSON.stringify(TOKEN)};
    const $ = id => document.getElementById(id);
    const say = t => { $('status').textContent = t; console.log('[status]', t); };

    let rec, chunks=[], blob, startAt;

    $('start').addEventListener('click', async () => {
      say('権限ダイアログ待機中…');
      try{
        const stream = await navigator.mediaDevices.getDisplayMedia({
          video:{ frameRate:30 },
          audio: $('withAudio').checked
        });
        $('v').srcObject = stream;

        let mtype =
          MediaRecorder.isTypeSupported('video/webm;codecs=vp9,opus') ? 'video/webm;codecs=vp9,opus' :
          MediaRecorder.isTypeSupported('video/webm;codecs=vp8,opus') ? 'video/webm;codecs=vp8,opus' :
          MediaRecorder.isTypeSupported('video/webm') ? 'video/webm' : '';

        const opts = { videoBitsPerSecond: +$('bitrate').value };
        if (mtype) opts.mimeType = mtype;

        try { rec = new MediaRecorder(stream, opts); }
        catch (e) {
          console.warn('MediaRecorder 1st fail:', e);
          mtype = MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : '';
          rec = new MediaRecorder(stream, mtype ? { mimeType: mtype, videoBitsPerSecond: +$('bitrate').value } : { videoBitsPerSecond: +$('bitrate').value });
        }

        chunks=[]; startAt=Date.now();
        rec.onstart = () => { say('録画中…（停止で確定）'); };
        rec.ondataavailable = e => { if (e.data && e.data.size) chunks.push(e.data); };
        rec.onerror = ev => { console.error('rec.onerror', ev.error); say('録画エラー: '+(ev.error?.message||ev)); };
        rec.onstop = () => {
          const type = rec.mimeType || mtype || 'video/webm';
          const b = new Blob(chunks, { type });
          $('v').srcObject = null;
          $('v').src = URL.createObjectURL(b);
          blob = b;
          $('upload').disabled = false;
          stream.getTracks().forEach(t=>t.stop());
          say(\\\`録画完了: \\\${(blob.size/1024/1024).toFixed(2)}MB\\\`);
        };

        rec.start(1000);
        $('start').disabled = true; $('stop').disabled = false; $('upload').disabled = true;

      }catch(e){ say('開始できません: ' + e.name + ' / ' + e.message); }
    });

    $('stop').addEventListener('click', () => {
      if (rec && rec.state !== 'inactive') {
        rec.stop();
        $('start').disabled = false; $('stop').disabled = true;
      }
    });

    $('upload').addEventListener('click', async () => {
      if (!blob) return;
      say('エンコード中…');
      const base64 = await new Promise((resolve,reject)=>{
        const r=new FileReader(); r.onloadend=()=>resolve(r.result); r.onerror=reject; r.readAsDataURL(blob);
      });
      say('アップロード中…');
      const meta = {
        filename: $('fname').value || 'screen-record.webm',
        mimeType: blob.type || 'video/webm',
        durationMs: Date.now() - startAt
      };
      const form = new FormData();
      form.append('token', TOKEN);
      form.append('meta', JSON.stringify(meta));
      form.append('data', base64);

      try{
        const res = await fetch(ENDPOINT, { method:'POST', body: form });
        const json = await res.json().catch(()=>({ok:false, error:'サーバ応答の解析に失敗'}));
        if (json.ok) say('保存しました: ' + json.url);
        else say('失敗: ' + (json.error || '不明なエラー'));
      }catch(e){ say('通信エラー: ' + e.message); }
    });
  })();
  </scr` + `ipt>`; // （GASのテンプレ整形対策）
  w.document.open(); w.document.write(html); w.document.close();
});
</script>
